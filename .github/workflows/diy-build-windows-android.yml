name: Build Vaultwarden (Windows + Android)

on:
  workflow_dispatch: {}
  push:
    tags:
      - 'v*'  # push tag like v1.2.3 会触发（可按需修改）

env:
  BINARY_NAME: vaultwarden
  OUT_DIR: release-artifacts

jobs:
  build-windows:
    name: Build Windows x86_64
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Windows release
        run: |
          cargo build --release --bin ${{ env.BINARY_NAME }} --target x86_64-pc-windows-msvc

      - name: Prepare Windows artifact
        run: |
          mkdir %OUT_DIR%
          copy target\x86_64-pc-windows-msvc\release\${{ env.BINARY_NAME }}.exe %OUT_DIR%\${{ env.BINARY_NAME }}.exe
          powershell -Command "Compress-Archive -Path '${{ env.OUT_DIR }}\\*' -DestinationPath '${{ env.BINARY_NAME }}-windows-x64.zip'"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: vaultwarden-windows-x64
          path: |
            ${{ env.BINARY_NAME }}-windows-x64.zip
            ${{ env.OUT_DIR }}/**

  build-android:
    name: Build Android (arm64 + armv7)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: linux-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --locked

      - name: Install Android NDK
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
          NDK_VER=r25b
          mkdir -p $HOME/android-ndk
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VER}-linux.zip -O ndk.zip
          unzip -q ndk.zip -d $HOME/android-ndk
          export ANDROID_NDK_HOME=$(ls -d $HOME/android-ndk/android-ndk-*)
          echo "ANDROID_NDK_HOME=${ANDROID_NDK_HOME}" >> $GITHUB_ENV
          rm ndk.zip

      - name: Install Android Rust targets
        run: |
          rustup target add aarch64-linux-android armv7-linux-androideabi

      - name: Build Android binaries
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          cargo ndk -t arm64-v8a -t armeabi-v7a --build release --bin ${{ env.BINARY_NAME }}

          mkdir -p ${{ env.OUT_DIR }}/android/arm64-v8a
          mkdir -p ${{ env.OUT_DIR }}/android/armeabi-v7a

          cp target/aarch64-linux-android/release/${{ env.BINARY_NAME }} ${{ env.OUT_DIR }}/android/arm64-v8a/
          cp target/armv7-linux-androideabi/release/${{ env.BINARY_NAME }} ${{ env.OUT_DIR }}/android/armeabi-v7a/

          (cd ${{ env.OUT_DIR }}/android/arm64-v8a && zip -r ../../vaultwarden-android-arm64.zip .)
          (cd ${{ env.OUT_DIR }}/android/armeabi-v7a && zip -r ../../vaultwarden-android-armv7.zip .)

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vaultwarden-android
          path: |
            ${{ env.OUT_DIR }}/*.zip
            ${{ env.OUT_DIR }}/android/**
