name: Build Vaultwarden (Windows + Android)

on:
  workflow_dispatch: {}
  push:
    tags:
      - 'v*'     # push tag like v1.2.3 会触发（可按需删除/修改）

env:
  # 可按需改名（可替换为仓库中真正的二进制名）
  BINARY_NAME: vaultwarden
  # Android 构建的输出目录
  OUT_DIR: release-artifacts

jobs:
  build-windows:
    name: Build Windows x86_64
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry & artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install MSVC build prerequisites
        # windows-latest 已自带 Visual Studio/MSVC 工具链
        run: |
          echo "MSVC toolchain should be available on windows-latest."

      - name: Build (release, x86_64-pc-windows-msvc)
        run: |
          cargo build --release --bin ${{ env.BINARY_NAME }} --target x86_64-pc-windows-msvc

      - name: Prepare output dir
        run: |
          mkdir %OUT_DIR%
          copy target\x86_64-pc-windows-msvc\release\${{ env.BINARY_NAME }}.exe %OUT_DIR%\${{ env.BINARY_NAME }}.exe || exit 0
          powershell -Command "Compress-Archive -Path '${{ env.OUT_DIR }}\\*' -DestinationPath '${{ env.BINARY_NAME }}-windows-x64.zip'"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: vaultwarden-windows-x64
          path: |
            ${{ env.BINARY_NAME }}-windows-x64.zip
            ${{ env.OUT_DIR }}/**

  build-android:
    name: Build Android (arm64 + armv7)
    runs-on: ubuntu-latest
    needs: []
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry & artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: linux-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-ndk
        run: |
          cargo install cargo-ndk --locked

      - name: Install Android NDK (via sdkmanager)
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
          # Download a recent Android NDK (r25c or r23b etc). Adjust version if needed.
          NDK_VER=r25b
          mkdir -p $HOME/android-ndk
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VER}-linux.zip -O ndk.zip
          unzip -q ndk.zip -d $HOME/android-ndk
          export ANDROID_NDK_HOME=$(ls -d $HOME/android-ndk/android-ndk-*)
          echo "ANDROID_NDK_HOME=${ANDROID_NDK_HOME}" >> $GITHUB_ENV
          rm ndk.zip

      - name: Add Android targets
        run: |
          rustup target add aarch64-linux-android armv7-linux-androideabi

      - name: Build for Android targets (arm64-v8a, armeabi-v7a)
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          # cargo-ndk will map arm64-v8a -> aarch64-linux-android, armeabi-v7a -> armv7-linux-androideabi
          # build both targets and collect into a single directory
          cargo ndk -t arm64-v8a -t armeabi-v7a --release --build --bin ${{ env.BINARY_NAME }}

          # create output dir and copy binaries
          mkdir -p ${{ env.OUT_DIR }}/android/arm64-v8a
          mkdir -p ${{ env.OUT_DIR }}/android/armeabi-v7a

          # cargo-ndk places artifacts under target/<target>/release/<binary>
          cp target/aarch64-linux-android/release/${{ env.BINARY_NAME }} ${{ env.OUT_DIR }}/android/arm64-v8a/${{ env.BINARY_NAME }} || true
          cp target/armv7-linux-androideabi/release/${{ env.BINARY_NAME }} ${{ env.OUT_DIR }}/android/armeabi-v7a/${{ env.BINARY_NAME }} || true

          # make zips
          (cd ${{ env.OUT_DIR }}/android/arm64-v8a && zip -r ../../${{ env.BINARY_NAME }}-android-arm64.zip .)
          (cd ${{ env.OUT_DIR }}/android/armeabi-v7a && zip -r ../../${{ env.BINARY_NAME }}-android-armv7.zip .)

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vaultwarden-android
          path: |
            ${{ env.OUT_DIR }}/*.zip
            ${{ env.OUT_DIR }}/android/**

